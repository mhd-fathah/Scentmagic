<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Scentmagic - Sales Report</title>
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <meta name="description" content="" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta property="og:title" content="" />
  <meta property="og:type" content="" />
  <meta property="og:url" content="" />
  <meta property="og:image" content="" />
  <!-- Favicon -->
  <link rel="shortcut icon" type="image/x-icon" href="/img/logo.png" />
  <!-- Include Material Icons (if required) -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <!-- Include any other required styles -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />

  <!-- Template CSS -->
  <script src="/js/admin/color-modes.js"></script>
  <link href="/css/admin/main.css" rel="stylesheet" type="text/css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/material-icons@1.13.12/iconfont/material-icons.min.css" rel="stylesheet" />
</head>

<body>
  <div class="screen-overlay"></div>
  <aside class="navbar-aside" id="offcanvas_aside">
    <div class="aside-top">
      <a href="index.html" class="brand-wrap">
        <img src="/img/logo.png" class="logo" alt="Scentmagic logo" />
      </a>
      <div>
        <button class="btn btn-icon btn-aside-minimize text-muted">
          <i class="fas fa-bars"></i>
        </button>
      </div>
    </div>
    <nav>
      <ul class="menu-aside">
        <li class="menu-item">
          <a class="menu-link" href="/admin/dashboard">
            <span class="text">Dashboard</span>
          </a>
        </li>
        <li class="menu-item">
          <a class="menu-link" href="/admin/products">
            <span class="text">Products</span>
          </a>
        </li>
        <li class="menu-item">
          <a class="menu-link" href="/admin/categories">
            <span class="text">Categories</span>
          </a>
        </li>

        <li class="menu-item">
          <a class="menu-link" href="/admin/orders">
            <span class="text">Orders</span>
          </a>
        </li>
        <li class="menu-item">
          <a class="menu-link" href="/admin/users">
            <span class="text">Users</span>
          </a>
        </li>
        <li class="menu-item">
          <a class="menu-link" href="/admin/products/add">
            <span class="text">Add Product</span>
          </a>
        </li>
        <li class="menu-item">
          <a class="menu-link" href="/admin/coupon">
            <span class="text">Coupons</span>
          </a>
        </li>
        <li class="menu-item">
          <a class="menu-link" href="/admin/offers">
            <span class="text">Offers</span>
          </a>
        </li>
        <li class="menu-item">
          <a class="menu-link" href="#">
            <span class="text">Reviews</span>
          </a>
        </li>
      </ul>
      <hr />
      <ul class="menu-aside">
        <li class="menu-item">
          <a class="menu-link" href="#">
            <span class="text">Account</span>
          </a>
        </li>
      </ul>
      <br />
      <br />
    </nav>
  </aside>
  <main class="main-wrap">
    <header class="main-header navbar">
      <div class="col-nav d-flex justify-content-end align-items-center w-100">
        <!-- Mobile Menu Button -->
        <button class="btn btn-icon btn-mobile me-auto d-lg-none" data-bs-toggle="offcanvas"
          data-bs-target="#offcanvas_aside">
          <i class="fas fa-bars"></i>
        </button>

        <!-- Navbar -->
        <ul class="nav ms-auto">
          <li class="dropdown nav-item">
            <a class="dropdown-toggle" data-bs-toggle="dropdown" href="#" id="dropdownAccount" aria-expanded="false">
              <img class="img-xs rounded-circle" src="/img/logo.png" alt="Admin" />
            </a>

            <!-- Dropdown Menu -->
            <div class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownAccount">
              <!-- Uncomment or add any menu items you need -->
              <!-- <a class="dropdown-item" href="#">
                        <i class="material-icons md-perm_identity"></i>Edit Profile
                      </a>
                      <a class="dropdown-item" href="#">
                        <i class="material-icons md-settings"></i>Account Settings
                      </a>
                      <a class="dropdown-item" href="#">
                        <i class="material-icons md-account_balance_wallet"></i>Wallet
                      </a>
                      <a class="dropdown-item" href="#">
                        <i class="material-icons md-receipt"></i>Billing
                      </a>
                      <a class="dropdown-item" href="#">
                        <i class="material-icons md-help_outline"></i>Help Center
                      </a> -->
              <div class="dropdown-divider"></div>
              <a class="dropdown-item text-danger" href="/admin/logout">
                <i class="material-icons md-exit_to_app"></i>Logout
              </a>
            </div>
          </li>
        </ul>
      </div>
    </header>

    <section class="content-main">
      <div class="content-header">
        <div>
          <h2 class="content-title card-title">Sales Report</h2>
          <p>Complete sales report and analytics</p>
        </div>
      </div>

      <div class="card mb-4">
        <header class="card-header">
          <h4 class="card-title">Sales Report</h4>
          <div class="row align-items-center">
            <div class="col-md-3 col-12 me-auto mb-md-0 mb-3">
              <div class="custom_select">
                <select class="form-select select-nice" id="reportType">
                  <option value="daily">Daily Report</option>
                  <option value="weekly">Weekly Report</option>
                  <option value="monthly">Monthly Report</option>
                  <option value="yearly">Yearly Report</option>
                  <option value="custom">Custom Date Range</option>
                </select>
              </div>
            </div>
            <div class="col-md-2 col-6">
              <input type="date" class="form-control" id="startDate" />
            </div>
            <div class="col-md-2 col-6 custom-date-range">
              <input type="date" class="form-control" id="endDate" />
            </div>
            <div class="col-md-2 col-6">
              <button class="btn btn-primary" onclick="generateReport()">
                Generate Report
              </button>
            </div>
            <div class="col-md-3 col-6">
              <button class="btn btn-success" onclick="downloadPDF()">
                Download PDF
              </button>
              <button class="btn btn-success" onclick="downloadExcel()">
                Download Excel
              </button>
            </div>
          </div>
        </header>

        <div class="card-body">
          <div class="row mb-4">
            <div class="col-lg-3 col-md-6">
              <div class="card card-body mb-4">
                <h6>Total Sales</h6>
                <h4 id="totalSales">₹<%= typeof totalSales !=='undefined' ? totalSales.toFixed(2) : '0.00' %>
                </h4>
              </div>
            </div>
            <div class="col-lg-3 col-md-6">
              <div class="card card-body mb-4">
                <h6>Discounts Applied</h6>
                <h4 id="totalDiscounts">₹<%= typeof totalDiscounts !=='undefined' ? totalDiscounts.toFixed(2) : '0.00'
                    %>
                </h4>
              </div>
            </div>
            <div class="col-lg-3 col-md-6">
              <div class="card card-body mb-4">
                <h6>Coupon Deductions</h6>
                <h4 id="totalCoupons">₹<%= typeof totalCoupons !=='undefined' ? totalCoupons.toFixed(2) : '0.00' %>
                </h4>
              </div>
            </div>
            <div class="col-lg-3 col-md-6">
              <div class="card card-body mb-4">
                <h6>Net Sales</h6>
                <h4 id="netSales">₹<%= typeof netSales !=='undefined' ? netSales.toFixed(2) : '0.00' %>
                </h4>
              </div>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table align-middle table-nowrap mb-0">
              <thead class="table-light">
                <tr>
                  <th scope="col" class="text-center">
                    <div class="form-check align-middle">
                      <input class="form-check-input" type="checkbox" id="selectAll" />
                      <label class="form-check-label" for="selectAll"></label>
                    </div>
                  </th>
                  <th class="align-middle" scope="col">Order ID</th>
                  <th class="align-middle" scope="col">Date</th>
                  <th class="align-middle" scope="col">Discount</th>
                  <th class="align-middle" scope="col">Coupon</th>
                  <th class="align-middle" scope="col">Total</th>
                  <th class="align-middle" scope="col">Payment Status</th>
                </tr>
              </thead>
              <tbody id="salesTableBody">
                <% if (typeof sales !=='undefined' && sales.length> 0) { %>

                  <% } else { %>
                    <tr>
                      <td colspan="7" class="text-center">No sales data available</td>
                    </tr>
                    <% } %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- content-main end// -->
    <footer class="main-footer font-xs">
      <div class="row pb-30 pt-15">
        <div class="col-sm-6">
          <script>
            document.write(new Date().getFullYear());
          </script>
          2024 © Nest - HTML Ecommerce Template .
        </div>
        <div class="col-sm-6">
          <div class="text-sm-end">All rights reserved</div>
        </div>
      </div>
    </footer>
  </main>



  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.19/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const reportType = document.getElementById('reportType');
      const startDate = document.getElementById('startDate');
      const endDate = document.getElementById('endDate');
      const customDateRange = document.querySelector('.custom-date-range');
      const selectAll = document.getElementById('selectAll');

      // Set default date to today
      // startDate.value = new Date().toISOString().split('T')[0];
      // endDate.value = new Date().toISOString().split('T')[0];

      // Handle report type change
      reportType.addEventListener('change', function () {
        if (this.value === 'custom') {
          customDateRange.style.display = 'block';
        } else {
          customDateRange.style.display = 'none';
          setDateRange(this.value);
        }
      });

      // Handle select all checkbox
      selectAll.addEventListener('change', function () {
        const checkboxes = document.querySelectorAll('#salesTableBody .form-check-input');
        checkboxes.forEach(checkbox => checkbox.checked = this.checked);
      });
    });

    function setDateRange(type) {
      const startDate = document.getElementById('startDate');
      const endDate = document.getElementById('endDate');
      const today = new Date();

      switch (type) {
        case 'daily':
          startDate.value = today.toISOString().split('T')[0];
          break;
        case 'weekly':
          const weekAgo = new Date(today);
          weekAgo.setDate(today.getDate() - 7);
          startDate.value = weekAgo.toISOString().split('T')[0];
          break;
        case 'monthly':
          const monthAgo = new Date(today);
          monthAgo.setMonth(today.getMonth() - 1);
          startDate.value = monthAgo.toISOString().split('T')[0];
          break;
        case 'yearly':
          const yearAgo = new Date(today);
          yearAgo.setFullYear(today.getFullYear() - 1);
          startDate.value = yearAgo.toISOString().split('T')[0];
          break;
      }
      endDate.value = today.toISOString().split('T')[0];
    }

    async function generateReport() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const reportType = document.getElementById('reportType').value;

      try {
        const response = await fetch('/admin/report', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            startDate,
            endDate,
            reportType
          })
        });

        if (!response.ok) throw new Error('Failed to fetch report data');

        const data = await response.json();
        updateReportDisplay(data);
      } catch (error) {
        console.error('Error generating report:', error);
        alert('Failed to generate report. Please try again.');
      }
    }

    function updateReportDisplay(data) {
      // Update summary cards
      document.getElementById('totalSales').textContent = `₹${data.totalSales.toFixed(2)}`;
      document.getElementById('totalDiscounts').textContent = `₹${data.totalDiscounts.toFixed(2)}`;
      document.getElementById('totalCoupons').textContent = `₹${data.totalCoupons.toFixed(2)}`;
      document.getElementById('netSales').textContent = `₹${data.netSales.toFixed(2)}`;

      // Update table
      const tableBody = document.getElementById('salesTableBody');
      if (data.sales && data.sales.length > 0) {
        const tableContent = data.sales.map(sale => `
                    <tr>
                        <td class="text-center">
                            <div class="form-check align-middle">
                                <input class="form-check-input" type="checkbox" />
                            </div>
                        </td>
                        <td>${sale.orderId}</td>
                        <td>${new Date(sale.date).toLocaleDateString()}</td>
                        <td>₹${(sale.discount || 0).toFixed(2)}</td>
                        <td>₹${(sale.coupon || 0).toFixed(2)}</td>
                        <td>₹${(sale.total || 0).toFixed(2)}</td>
                        <td>
                            <span class="badge badge-pill badge-soft-${sale.paymentStatus.toLowerCase() === 'paid' ? 'success' : 'warning'}">
                                ${sale.paymentStatus}
                            </span>
                        </td>
                    </tr>
                `).join('');
        tableBody.innerHTML = tableContent;
      } else {
        tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No sales data available</td></tr>';
      }
    }

    async function downloadPDF() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const reportType = document.getElementById('reportType').value;

      try {
        const response = await fetch('/admin/report/pdf', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ reportType,startDate, endDate })
        });

        if (!response.ok) throw new Error('Failed to generate PDF');

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `sales-report-${startDate}-to-${endDate}.pdf`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      } catch (error) {
        console.error('Error downloading PDF:', error);
        alert('Failed to download PDF. Please try again.');
      }
    }

    async function downloadExcel() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const reportType = document.getElementById('reportType').value;

      try {
        const response = await fetch('/admin/report/excel', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ reportType, startDate, endDate })
        });

        if (!response.ok) throw new Error('Failed to generate Excel file');

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `sales-report-${startDate}-to-${endDate}.xlsx`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      } catch (error) {
        console.error('Error downloading Excel:', error);
        alert('Failed to download Excel. Please try again.');
      }
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="/js/admin//jquery-3.6.0.min.js"></script>
  <script src="/js/admin/bootstrap.bundle.min.js"></script>
  <script src="/js/admin/select2.min.js"></script>
  <script src="/js/admin/perfect-scrollbar.js"></script>
  <script src="/js/admin/jquery.fullscreen.min.js"></script>
  <script src="/js/admin/chart.js"></script>
  <!-- Main Script -->
  <script src="/js/admin/main.js" type="text/javascript"></script>
  <script src="/js/admin/custom-chart.js" type="text/javascript"></script>
</body>

</html>